var pimpMyFilter;var pimpFields;(function(e){pimpMyFilter={NAME:"PimpMyFilter",VERSION:"0.1",AUTHOR:{name:"Fynjah",mail:"fynjah@gmail.com"},setModalWidth:function(t){_this=this;_this.settings.modalWidth=t;e(this.__object).css({width:_this.settings.modalWidth,marginLeft:_this.settings.modalWidth/-2})},useFilter:function(t){if(t!==""&&t!=="undefined"){var n=false;var r=e.ajax({type:"GET",data:"filter_id="+parseInt(t),url:this.settings.url+"use_filter/",dataType:"json",global:false,async:false,success:function(e){n=e}});return n}else return false},getFiltersByUser:function(){var t=false;var n=e.ajax({type:"GET",url:this.settings.url+"get_filters_by_user/",dataType:"json",global:false,async:false,success:function(e){t=e}});return t},__object:null,__buttonRemove:function(){button=e("<button/>").addClass("btn row-remove btn-block").text("Remove").css({margin:"0 10px 0 0"});div=e("<div/>").addClass("span3");_this=this;button.on("click",function(t){t.preventDefault();e(this).parent().parent().remove();if(e(_this.__object).find(".modal-body form .condition").size()<_this.settings.limit&&e(_this.__object).find("a.new-row").hasClass("disabled")){e(_this.__object).find("a.new-row").removeClass("disabled")}});div.append(button);return e(div)},__row:function(){row=e("<div/>").addClass("row-fluid");return e(row)},__select:function(t,n){select=e("<select/>").addClass(t).attr("name",t).html(n).addClass("input-block-level");div=e("<div/>").addClass("span3");div.append(select);return e(div)},__condition:function(){condition=this.__row();condition.addClass("condition");dv=e("<div/>").addClass("span12 well well-small").css({marginBottom:"10px"});dv_value=e("<div/>").addClass("span3 value-wrap pull-left");operators='<option value="0">-----</option>';fields='<option value="0">-----</option>';e.each(this.settings.structure.operators,function(e,t){operators+='<option value="'+t[0]+'">'+t[1]+"</option>"});e.each(this.settings.structure.fields,function(e,t){fields+='<option value="'+t.name+'">'+t.name+"</option>"});select_field=this.__select("fields",fields);_this=this;select_field.find("select").on("change",function(t){t.preventDefault();_select=e(this);val=e(this).val();if(val==="0"){_select.parent().parent().find(".value-wrap").html("")}else{e.each(_this.settings.structure.fields,function(e,t){if(t.name===val){_select.parent().parent().find(".value-wrap").html(pimpFields[t.type](t))}})}});dv.append(select_field);dv.append(this.__select("operators",operators));dv.append(dv_value);if(this.settings.limit!==1){dv.append(this.__buttonRemove())}condition.append(dv);return e(condition)},__menu:function(){menu=this.__row();dv_menu=e("<div/>").addClass("span12");filter_name=e("<input/>").attr("type","text").attr("placeholder","Filter name").addClass("filter_name input-block-level").attr("required","required");dv_filter_name=e("<div/>").addClass("span3").append(filter_name);new_cond_button=e("<a/>").addClass("btn new-row span3").attr("href","#").html('<i class="icon-plus"></i> Add condition').attr("title","New condition");quick=e("<label/>").addClass("checkbox inline span3");quick.append(e("<input/>").attr("type","checkbox").addClass("quick-filter"));quick.append("Quick filter?");_this=this;new_cond_button.on("click",function(t){t.preventDefault();if(e(this).hasClass("disabled")){return false}else{filter=e(_this.__object).find(".modal-body form");filter.append(_this.__condition());if(_this.settings.limit!==0&&filter.find(".condition").size()>=_this.settings.limit){e(this).addClass("disabled")}}});if(this.settings.limit!==1){dv_menu.append(new_cond_button)}dv_menu.append(dv_filter_name);dv_menu.append(quick);menu.append(dv_menu);return e(menu)},__save_button:function(){btn=e("<a/>").addClass("btn btn-primary save-filter").html("Save filter").attr("href","#").attr("title","Save filter");_this=this;btn.on("click",function(t){t.preventDefault();_this.__save_filter(e(_this.__object).find("form.filter"))});return e(btn)},__save_filter:function(t){_this=this;var n=false;if(t.find("input.filter_name").val()===""){n=true;t.find("input.filter_name").css({outline:"1px solid #ff0000"})}else{t.find("input.filter_name").css({outline:"none"})}response={name:t.find("input.filter_name").val(),quick:t.find("input.quick-filter").prop("checked"),app:_this.settings.app,model:_this.settings.model};conditions={};e.each(t.find(".condition"),function(t,r){var i=e(r).find("select.fields").val();var s=e(r).find("select.operators").val();var o=e(r).find("input.value");var u=o.data("pimpMyFilter");var a=o.val();if(i==="0"||s==="0"||a==="undefined"||a===""){e(this).find(".span12").css({outline:"1px solid #ff0000"});n=true}else{e(this).find(".span12").css({outline:"none"})}conditions[t]={field:encodeURIComponent(i),operator:encodeURIComponent(s),value:encodeURIComponent(a),value_data:u}});response.conditions=conditions;if(!n){var r=e.ajax({type:"POST",data:"filter="+window.JSON.stringify(response),url:_this.settings.url+"save_filter/",dataType:"json",global:false,async:false,success:function(e){_this.__hideBody()}})}},__hideBody:function(){_this=this;m_body=e(_this.__object).find(".modal-body");m_body.animate({opacity:0},1e3);m_body.queue(function(){e(_this.__object).modal("hide");m_body.css({opacity:1});e(this).dequeue()});return m_body},__createFilter:function(){this.setModalWidth(this.settings.modalWidth);body=e(this.__object).find(".modal-body");body.html("");settings=this.settings;if(!settings.structure&&settings.app&&settings.model){if(settings.app&&settings.model){var t=e.ajax({type:"POST",data:"app="+settings.app+"&model="+settings.model,url:settings.url+"get_structure/",dataType:"json",global:false,async:false,success:function(e){settings.structure=e}})}else{e.error('Options "app" and "model" must be assigned, if option "structure" not assigned.');return false}}header=e(this.__object).find(".modal-header h3");header.text(settings.header+" for "+settings.name);if(!e(".modal-footer .save-filter").size()>0)e(this.__object).find(".modal-footer").append(this.__save_button()).css({position:"relative",zIndex:1});code=e("<div/>").append("<form/>");thead=this.__row();thead.append('<div class="span3" style="text-align:center;">Field</div>');thead.append('<div class="span3" style="text-align:center;">Logical operator</div>');thead.append('<div class="span3" style="text-align:center;">Value</div>');filter=code.find("form");filter.addClass("form-inline filter");filter.append(this.__menu());filter.append(thead);filter.append(this.__condition());body.html(code);return e(this.__object)},__typeahead_storage:{},settings:{structure:null,header:"New filter",app:null,model:null,name:"",modalWidth:800,url:"/pimp-my-filter/",limit:0}};pimpFields={__parent:pimpMyFilter,__AbstractInputField:function(t){var n=e("<input/>").addClass("value input-block-level");var r=t;n.data("pimpMyFilter",r);return n},__AbstractSelectField:function(t){var n=e("<select/>").addClass("value input-block-level");var r=t;n.data("pimpMyFilter",r);return n},ForeignKey:function(t){var n=this.__AbstractInputField(t);n.attr("autocomplete","off").attr("type","text").attr("placeholder","Start typing...");var r=[];var i=this;var s=e.ajax({type:"POST",data:"field="+t.name+"&app="+this.__parent.settings.app+"&model="+this.__parent.settings.model,url:this.__parent.settings.url+"get_typeahead/",dataType:"json",global:false,async:true,success:function(s){i.__parent.__typeahead_storage[t.type+"__"+t.name]=s;e.each(s,function(e,t){r.push(t.unicode)});n.typeahead({source:r,updater:function(r){obj=i.__parent.__typeahead_storage[t.type+"__"+t.name];e.each(obj,function(t,i){if(i.unicode===r){s=e(n).data("pimpMyFilter");s.fk_id=i.id;e(n).data("pimpMyFilter",s)}});return r}})}});return n},CharField:function(e){return this.__AbstractInputField(e).attr("type","text")},BooleanField:function(t){var n=this.__AbstractInputField(t).attr("type","checkbox");n=e("<label/>").append(n).append("<small> False</small>");n.on("click",function(){if(e(this).find("input").is(":checked")){e(this).find("small").text(" True")}else{e(this).find("small").text(" False")}});return n},IntegerField:function(e){return this.__AbstractInputField(e).attr("type","number")},BigIntegerField:function(e){return this.__AbstractInputField(e).attr("type","number")},CommaSeparatedIntegerField:function(e){return this.__AbstractInputField(e).attr("type","text")},DateField:function(e){return this.__AbstractInputField(e).attr("type","date")},DateTimeField:function(e){return this.__AbstractInputField(e).attr("type","datetime-local")},DecimalField:function(e){var t=this.__AbstractInputField(e).attr("type","number");t.attr("placeholder","1.0");t.attr("pattern","(^[+]?d*.?d*[1-9]+d*$)|(^[+]?[1-9]+d*.d*$)");return t},EmailField:function(e){return this.__AbstractInputField(e).attr("type","email")},FileField:function(e){return this.BooleanField(e)},FieldFile:function(e){return this.BooleanField(e)},FilePathField:function(e){return this.__AbstractInputField(e).attr("type","text")},FloatField:function(e){return this.DecimalField(e)},ImageField:function(e){return this.BooleanField(e)},IntegerField:function(e){var t=this.__AbstractInputField(e).attr("type","number");t.attr("pattern","^[0-9]+$");return t},IPAddressField:function(e){var t=this.__AbstractInputField(e).attr("type","text");t.attr("placeholder","255.255.255.255");t.attr("pattern","((^|.)((25[0-5])|(2[0-4]d)|(1dd)|([1-9]?d))){4}$");return t},GenericIPAddressField:function(e){return this.IPAddressField(e)},NullBooleanField:function(e){return this.BooleanField(e)},PositiveIntegerField:function(e){return this.__AbstractInputField(e).attr("type","number")},PositiveSmallIntegerField:function(e){return this.__AbstractInputField(e).attr("type","number")},SlugField:function(e){return this.__AbstractInputField(e).attr("type","text").attr("pattern","^[a-zA-Z0-9-_]+$")},SmallIntegerField:function(e){return this.__AbstractInputField(e).attr("type","number")},TextField:function(e){return this.__AbstractInputField(e).attr("type","text")},TimeField:function(e){return this.__AbstractInputField(e).attr("type","time")},URLField:function(e){return this.__AbstractInputField(e).attr("type","url")},ManyToManyField:function(e){return this.ForeignKey(e)},OneToOneField:function(e){return this.ForeignKey(e)}};var t={init:function(t){var n=e.extend(pimpMyFilter.settings,t);pimpMyFilter.settings=e.extend(n,t);pimpMyFilter.__object=this;e(this).off(".data-api").modal("show");e(this).find(".modal-body").css({overflow:"visible"});return pimpMyFilter.__createFilter()},newCondition:function(){filter=this.find(".modal-body form");filter.append(pimpMyFilter.__condition());return this}};e.fn.pimpMyFilter=function(n){if(t[n]){return t[n].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof n==="object"||!n){return t.init.apply(this,arguments)}else{e.error("Method "+n+" does not exist.")}}})(jQuery)